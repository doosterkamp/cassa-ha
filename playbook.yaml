---
- name: "Create Homey Assistant Restore Image"
  hosts: image
  vars:
    ansible_python_interpreter: /usr/bin/python3
  gather_facts: false
  pre_tasks:
    - name: Ensure python3 is installed in chroot
      raw: |
        if [ ! -x /usr/bin/python3 ]; then
          if command -v apt-get >/dev/null 2>&1; then
            apt-get update && apt-get install -y python3
          elif command -v apk >/dev/null 2>&1; then
            apk add --no-cache python3
          elif command -v dnf >/dev/null 2>&1; then
            dnf install -y python3
          elif command -v yum >/dev/null 2>&1; then
            yum install -y python3
          fi
        fi
  roles:
    - role: homey_fixes
      tags: ['homey']
    - role: serial_getty
      tags: ['console']
    - role: os_upgrade
      tags: ['upgrade']
    - role: home_assistant
      tags: ['ha']
